<!doctype html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8"/>
    <title>Mail Receiver</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <style>
        .toast-container {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 9999;
        }
        .status-icon {
            font-size: 1.2rem;
            margin-right: 0.5rem;
        }
        .status-icon.orange {
            color: orange;
        }
        .status-icon.green {
            color: green;
        }
        #historyTable th,
        #historyTable td {
            text-align: center;
            vertical-align: middle;
        }
        .download-btn {
            padding: 0.5rem 1.5rem;
            font-size: 1.1rem;
        }

        .approve-checkbox {
            margin-right: 1.5rem;
        }
        #pendingUsersSection tr td {
            border-bottom: 1px solid #dee2e6;
            padding: 0.75rem;
        }

        #pendingUsersSection table {
            border-collapse: collapse;
            width: 100%;
        }

        #pendingUsersSection tr {
            height: 50px !important;
        }

        .approve-checkbox-container {
            height: 60px !important;
            min-height: 60px;
            padding-bottom: 20px !important;
            display: flex !important;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
        }
        #pendingUsersSection th,
        #pendingUsersSection td {
            text-align: center;
            vertical-align: middle;
            padding: 12px 8px;
            border-bottom: 1px solid #dee2e6 !important;
        }

        .approve-checkbox {
            transform: scale(1.3);
            margin: 0;
        }

        .checkbox-cell {
            position: relative;
            padding-bottom: 18px !important;
        }
    </style>
</head>
<body>

<div class="toast-container p-3" id="toastPlacement"></div>

<div class="container-fluid">
    <div class="row">
        <div class="col-3 bg-light vh-100 pt-4" style="min-height:100vh;">
            <h4 class="text-center">–ú–µ–Ω—é</h4>
            <hr>
            <button type="button"
                    class="btn btn-primary w-100 mb-3"
                    id="toggleGroups">
                –ì—Ä—É–ø–ø—ã –¥–ª—è —Ä–∞—Å—Å—ã–ª–æ–∫
            </button>
            <button type="button" class="btn btn-primary w-100 mb-3" data-bs-toggle="modal" data-bs-target="#sendMailModal">
                –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É
            </button>
            <button type="button" class="btn btn-primary w-100 mb-3" id="toggleMailing">
                –ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—Å—ã–ª–æ–∫
            </button>
            <button type="button" class="btn btn-primary w-100 mb-3" id="togglePendingUsers">
                –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏
            </button>
            <button type="button" class="btn btn-primary w-100 mb-3" data-bs-toggle="modal" data-bs-target="#mailCredentialsModal">
                –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ—á—Ç—É
            </button>
            <button type="button"
                    class="btn btn-primary w-100 mb-3"
                    id="toggleBizproc">
                –ë–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å—ã
            </button>
            <button type="button"
                    class="btn btn-primary w-100 mb-3"
                    id="toggleActionLog">
                –ñ—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π
            </button>


        </div>

        <div class="col-9">
            <div class="p-4">
                <div id="bizprocSection" style="display:none;">
                    <h2>–ë–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å—ã</h2>
                    <hr>

                    <button class="btn btn-success mb-3" id="addBizprocBtn">
                        ‚ûï –î–æ–±–∞–≤–∏—Ç—å –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å
                    </button>

                    <table class="table table-striped align-middle" id="bizprocTable">
                        <thead>
                        <tr>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>

                    <hr>

                    <button class="btn btn-secondary mb-3" id="addStageBtn">
                        ‚ûï –î–æ–±–∞–≤–∏—Ç—å —ç—Ç–∞–ø—ã –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–∞
                    </button>

                    <table class="table table-bordered align-middle" id="stageTable">
                        <thead>
                        <tr>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ —ç—Ç–∞–ø–∞</th>
                            <th>–ì—Ä—É–ø–ø–∞ —Ä–∞—Å—Å—ã–ª–∫–∏</th>
                            <th>–¢–µ–∫—Å—Ç –ø–∏—Å—å–º–∞</th>
                            <th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div id="groupsSection" style="display:none;">
                    <h2>–ì—Ä—É–ø–ø—ã –¥–ª—è —Ä–∞—Å—Å—ã–ª–æ–∫</h2><hr>

                    <button class="btn btn-success mb-3"
                            data-bs-toggle="modal"
                            data-bs-target="#createGroupModal">
                        ‚ûï –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É
                    </button>

                    <table class="table" id="groupsTable">
                        <thead>
                        <tr>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</th>
                            <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</th>
                            <th class="text-center"></th>

                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div id="mailHistorySection" style="display: none;">
                    <h2>–ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—Å—ã–ª–æ–∫</h2>
                    <hr>

                    <table class="table" id="historyTable">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>–¢–µ–º–∞</th>
                            <th>–ì—Ä—É–ø–ø–∞</th>
                            <th>–î–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏</th>
                            <th>–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ / –í—Å–µ–≥–æ</th>
                            <th>–ü–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</th>
                        </tr>
                        </thead>
                        <tbody id="historyBody">
                        </tbody>
                    </table>
                </div>
                <div id="actionLogSection" style="display:none;">
                    <h2>–ñ—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π</h2><hr>

                    <button class="btn btn-success mb-3" id="addActionBtn">
                        ‚ûï –°–æ–∑–¥–∞—Ç—å
                    </button>

                    <table class="table table-striped" id="actionLogTable">
                        <thead>
                        <tr>
                            <th>–ë–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å</th>
                            <th>–≠—Ç–∞–ø</th>
                            <th>–î–∞—Ç–∞</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div id="pendingUsersSection" style="display: none;">
                    <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏</h3>
                    <table class="table">
                        <thead>
                        <tr>
                            <th>–ü–æ—á—Ç–∞</th>
                            <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–†–æ–ª—å</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="user : ${pendingUsers}">
                            <td th:text="${user.email}"></td>

                            <td th:text="${
  #strings.substring(user.registrationDate, 3, 5) + '.' +
  #strings.substring(user.registrationDate, 0, 2) + '.' +
  #strings.substring(user.registrationDate, 6, 10)
}"></td>
                            <td class="approve-checkbox-container d-flex justify-content-center align-items-center">
                                <input type="checkbox" class="approve-checkbox"
                                       th:attr="data-user-id=${user.id}"
                                       th:checked="${user.enabled}" />
                            </td>
                            <td>
                                <select class="role-select" th:attr="data-user-id=${user.id}">
                                    <option value="VIEW"  th:selected="${user.role.name() == 'VIEW'}">–ê–Ω–∞–ª–∏—Ç–∏–∫</option>
                                    <option value="USER"  th:selected="${user.role.name() == 'USER'}">–ú–∞—Ä–∫–µ—Ç–æ–ª–æ–≥</option>
                                    <option value="ADMIN" th:selected="${user.role.name() == 'ADMIN'}">–ê–¥–º–∏–Ω</option>
                                </select>
                            </td>
                        </tr>
                        </tbody>
                    </table>

                </div>




            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="createGroupModal" tabindex="-1" aria-labelledby="createGroupModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createGroupModalLabel">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createGroupForm">
                    <div class="mb-3">
                        <label for="groupName" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã:</label>
                        <input type="text" class="form-control" id="groupName" name="groupName" required/>
                    </div>
                    <div class="mb-3">
                        <label for="file" class="form-label">–§–∞–π–ª CSV (–ò–º—è;Email):</label>
                        <input type="file" class="form-control" id="file" name="file" required/>
                    </div>
                    <button type="submit" class="w-100 btn-success btn">–°–æ–∑–¥–∞—Ç—å</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="mailCredentialsModal" tabindex="-1" aria-labelledby="mailCredentialsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="mailCredentialsForm" action="/saveCredentials" method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="mailCredentialsModalLabel">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ—á—Ç–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" name="email" placeholder="example@gmail.com" required>
                    </div>
                    <div class="mb-3">
                        <label for="appPassword" class="form-label">–ü–∞—Ä–æ–ª—å</label>
                        <input type="password" class="form-control" id="appPassword" name="appPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" required>
                    </div>
                    <div class="mb-3">
                        <label for="appPassword" class="form-label">–•–æ—Å—Ç</label>
                        <input type="password" class="form-control" id="appPassword2" name="appPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ host" required>
                    </div>
                    <div class="mb-3">
                        <label for="appPassword" class="form-label">–ü–æ—Ä—Ç</label>
                        <input type="password" class="form-control" id="appPassword3" name="appPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–æ—Ä—Ç" required>
                    </div>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="submit" class="btn btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="sendMailModal" tabindex="-1" aria-labelledby="sendMailModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sendMailModalLabel">–°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="sendMailForm">
                    <div class="mb-3">
                        <label for="group-name" class="form-label">–ì—Ä—É–ø–ø–∞*</label>
                        <input type="text" class="form-control" id="group-name" name="groupName" required/>
                    </div>
                    <div class="mb-3">
                        <label for="subject" class="form-label">–¢–µ–º–∞ –ø–∏—Å—å–º–∞*</label>
                        <input type="text" class="form-control" id="subject" name="subject" required/>
                    </div>
                    <div class="mb-3">
                        <label for="message" class="form-label">–¢–µ–∫—Å—Ç –ø–∏—Å—å–º–∞*</label>
                        <textarea class="form-control" id="message" name="message" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="sendDate" class="form-label">–î–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:</label>
                        <input type="date" class="form-control" id="sendDate" name="sendDate"/>
                    </div>
                    <div class="mb-3">
                        <label for="sendTime" class="form-label">–í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏:</label>
                        <input type="time" class="form-control" id="sendTime" name="sendTime"/>
                    </div>
                    <button type="submit" class="btn btn-success w-100">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="createActionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="createActionForm">
                <div class="modal-header">
                    <h5 class="modal-title">–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">–ë–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å</label>
                        <select class="form-select" id="actionBpSelect" required></select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–≠—Ç–∞–ø</label>
                        <select class="form-select" id="actionStageSelect" required></select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–¢–µ–∫—Å—Ç –ø–∏—Å—å–º–∞</label>
                        <textarea class="form-control"
                                  id="actionMailPreview"
                                  rows="4"
                                  readonly></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary w-100" type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="createBpModal" tabindex="-1" aria-labelledby="createBpModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="createBpForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="createBpModalLabel">–ù–æ–≤—ã–π –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="bpName" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ*</label>
                        <input type="text" class="form-control" id="bpName" required>
                    </div>
                    <div class="mb-3">
                        <label for="bpDesc" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea class="form-control" id="bpDesc" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary w-100">–°–æ–∑–¥–∞—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="createStageModal" tabindex="-1" aria-labelledby="createStageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="createStageForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="createStageModalLabel">–ù–æ–≤—ã–π —ç—Ç–∞–ø</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="stageName" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —ç—Ç–∞–ø–∞*</label>
                        <input type="text" class="form-control" id="stageName" required>
                    </div>
                    <div class="mb-3">
                        <label for="stageGroup" class="form-label">–ì—Ä—É–ø–ø–∞ —Ä–∞—Å—Å—ã–ª–∫–∏*</label>
                        <input type="text" class="form-control" id="stageGroup" required>
                    </div>
                    <div class="mb-3">
                        <label for="stageText" class="form-label">–¢–µ–∫—Å—Ç –ø–∏—Å—å–º–∞*</label>
                        <textarea class="form-control" id="stageText" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="stagePriority" class="form-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç (—á–∏—Å–ª–æ)</label>
                        <input type="number" class="form-control" id="stagePriority" value="0">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary w-100">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="Roboto-Regular-normal.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
    function showToast(message, isError = false) {
        const container = document.getElementById('toastPlacement');
        const toastEl = document.createElement('div');
        toastEl.classList.add('toast', 'align-items-center', 'text-bg-' + (isError ? 'danger' : 'success'));
        toastEl.setAttribute('role', 'alert');
        toastEl.setAttribute('aria-live', 'assertive');
        toastEl.setAttribute('aria-atomic', 'true');
        toastEl.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto"
                        data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        container.appendChild(toastEl);
        const toast = new bootstrap.Toast(toastEl, { delay: 4000 });
        toast.show();
        toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
    }

    const createGroupForm = document.getElementById('createGroupForm');
    createGroupForm.addEventListener('submit', async function (evt) {
        evt.preventDefault();
        const formData = new FormData(createGroupForm);
        try {
            const response = await fetch('/groups/create', {
                method: 'POST',
                body: formData
            });
            if (response.ok) {
                const text = await response.text();
                showToast(text, false);
                const modal = bootstrap.Modal.getInstance(document.getElementById('createGroupModal'));
                modal.hide();
            } else {
                const text = await response.text();
                showToast(text, true);
            }
        } catch (e) {
            showToast("–û—à–∏–±–∫–∞: " + e.message, true);
        }
    });

    const mailCredentialsForm = document.getElementById('mailCredentialsForm');

    mailCredentialsForm.addEventListener('submit', async function (evt) {
        evt.preventDefault();
        const formData = new FormData(mailCredentialsForm);
        try {
            const response = await fetch('/saveCredentials', {
                method: 'POST',
                body: formData
            });
            if (response.ok) {
                const text = await response.text();
                showToast(text, false);
                const modal = bootstrap.Modal.getInstance(document.getElementById('mailCredentialsModal'));
                modal.hide();
            } else {
                const text = await response.text();
                showToast(text, true);
            }
        } catch (e) {
            showToast("–û—à–∏–±–∫–∞: " + e.message, true);
        }
    });

    const sendMailForm = document.getElementById('sendMailForm');
    sendMailForm.addEventListener('submit', async function (evt) {
        evt.preventDefault();
        const formData = new FormData(sendMailForm);
        const requestObject = Object.fromEntries(formData.entries());
        try {
            const response = await fetch('/sendmail', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestObject)
            });
            const text = await response.text();
            if (response.ok) {
                showToast(text, false);
                const modal = bootstrap.Modal.getInstance(document.getElementById('sendMailModal'));
                modal.hide();
            } else if (response.status === 403) {
                showToast("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É —Ä–∞—Å—Å—ã–ª–∫–∏", true);
            }
            else {
                showToast(text, true);
            }
        } catch (e) {
            showToast("–û—à–∏–±–∫–∞: " + e.message, true);
        }
    });

    document.getElementById('togglePendingUsers').addEventListener('click', () => {
        const pendingSection = document.getElementById('pendingUsersSection');
        const historySection = document.getElementById('mailHistorySection');
        const bizprocSection = document.getElementById('bizprocSection');
        const actionLogSection = document.getElementById('actionLogSection');
        const sec = document.getElementById('groupsSection');
        if (pendingSection.style.display === 'block') {
            pendingSection.style.display = 'none';
        } else {
            historySection.style.display = 'none';
            bizprocSection.style.display = 'none';
            actionLogSection.style.display = 'none';
            sec.style.display = 'none';
            pendingSection.style.display = 'block';
        }
    });

    document.getElementById('toggleMailing').addEventListener('click', async () => {
        const historySection = document.getElementById('mailHistorySection');
        const pendingSection = document.getElementById('pendingUsersSection');
        const bizprocSection = document.getElementById('bizprocSection');
        const actionLogSection = document.getElementById('actionLogSection');
        const sec = document.getElementById('groupsSection');

        if (historySection.style.display === 'block') {
            historySection.style.display = 'none';
        } else {
            await loadHistory();
            pendingSection.style.display = 'none';
            bizprocSection.style.display = 'none';
            actionLogSection.style.display = 'none';
            sec.style.display = 'none';
            historySection.style.display = 'block';
        }
    });

    document.querySelectorAll('.approve-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const userId = this.getAttribute('data-user-id');
            fetch('/admin/toggle-user', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({
                    userId: userId,
                    enabled: this.checked
                })
            }).then(response => {
                if (response.ok) {
                    showToast(this.checked ? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–¥–æ–±—Ä–µ–Ω' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω', false);
                } else {
                    this.checked = !this.checked;
                    response.text().then(text => showToast(text, true));
                }
            }).catch(error => {
                this.checked = !this.checked;
                showToast("–û—à–∏–±–∫–∞: " + error.message, true);
            });
        });
    });

    document.querySelectorAll('.role-select').forEach(select => {
        select.addEventListener('change', function() {
            const userId = this.getAttribute('data-user-id');
            const newRole = this.value;  // "VIEW", "USER" –∏–ª–∏ "ADMIN"

            fetch('/admin/change-role', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({
                    userId: userId,
                    newRole: newRole
                })
            })
                .then(response => {
                    if (response.ok) {
                        return response.text();
                    } else {
                        throw new Error("–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–æ–ª–∏. –ö–æ–¥ " + response.status);
                    }
                })
                .then(text => {
                    showToast(text, false);
                })
                .catch(error => {
                    showToast(error.message, true);
                });
        });
    });

    async function loadHistory() {
        const historyBody = document.getElementById('historyBody');
        historyBody.innerHTML = '';
        try {
            const resp = await fetch('/stats');
            if (!resp.ok) {
                showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Ä–∞—Å—Å—ã–ª–æ–∫', true);
                return;
            }
            const data = await resp.json();

            data.forEach(m => {
                const tr = document.createElement('tr');
                const formattedDate = formatDateTime(m.sendDate);

                tr.innerHTML = `
                <td>${m.mailingId}</td>
                <td>${m.subject}</td>
                <td>${m.groupName}</td>
                <td>${formattedDate}</td>
                <td>${m.totalRecipients - m.failedRecipientsCount}/${m.totalRecipients}</td>
                <td>
                    <button class="btn btn-success btn-sm"
                            onclick="getStats(${m.mailingId})">
                        –°–∫–∞—á–∞—Ç—å
                    </button>
                </td>
            `;
                historyBody.appendChild(tr);
            });
        } catch (e) {
            showToast('–û—à–∏–±–∫–∞: ' + e.message, true);
        }
    }

    function formatDateTime(isoString) {
        const date = new Date(isoString);

        return date.toLocaleDateString('ru-RU').replace(',', '');
    }

    async function getStats(mailingId) {
        try {
            const resp = await fetch(`/stats/${mailingId}`);
            if (!resp.ok) {
                console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏");
                return;
            }
            const m = await resp.json();

            const deliveredCount = m.totalRecipients - m.failedRecipientsCount;
            let content = "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ä–∞—Å—Å—ã–ª–∫–µ\n";
            content += `ID: ${m.mailingId}\n`;
            content += `–¢–µ–º–∞: ${m.subject}\n`;
            content += `–°–æ–æ–±—â–µ–Ω–∏–µ: ${m.message}\n`;
            content += `–ì—Ä—É–ø–ø–∞: ${m.groupName}\n`;
            content += `–î–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${m.sendDate}\n`;
            content += `–í—Å–µ–≥–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${m.totalRecipients}\n`;
            content += "–°–ø–∏—Å–æ–∫ –∞–¥—Ä–µ—Å–∞—Ç–æ–≤:\n";
            m.recipients.forEach(r => {
                let status = r.delivered ? "(OK)" : "(FAIL)";
                content += `- ${r.email} ${status}\n`;
            });

            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mailing_${m.mailingId}.txt`;

            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            console.log("–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–ª—Å—è!");
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞:", e);
        }
    }

    document.getElementById('toggleBizproc').addEventListener('click', async () => {
        const bpSection = document.getElementById('bizprocSection');
        const histSection = document.getElementById('mailHistorySection');
        const pendSection = document.getElementById('pendingUsersSection');
        const actionLogSection = document.getElementById('actionLogSection');
        const sec = document.getElementById('groupsSection');
        histSection.style.display = 'none';
        pendSection.style.display = 'none';
        actionLogSection.style.display = 'none';
        sec.style.display = 'none';
        if (bpSection.style.display === 'block') {
            bpSection.style.display = 'none';
        } else {
            await loadBizprocs();
            bpSection.style.display = 'block';
        }
    });

    let currentBpId = null;
    document.getElementById('addBizprocBtn')
        .addEventListener('click', () =>
            new bootstrap.Modal('#createBpModal').show());

    document.getElementById('addStageBtn')
        .addEventListener('click', () => {
            if (!currentBpId) return showToast('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å', true);
            new bootstrap.Modal('#createStageModal').show();
        });

    document.getElementById('createBpForm')
        .addEventListener('submit', async evt => {
            evt.preventDefault();
            const name = document.getElementById('bpName').value.trim();
            const description = document.getElementById('bpDesc').value.trim();

            try {
                await fetch('/api/bizprocs', {
                    method : 'POST',
                    headers: { 'Content-Type':'application/json' },
                    body   : JSON.stringify({ name, description })
                });
                showToast('–ë–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω');
                bootstrap.Modal.getInstance('#createBpModal').hide();
                await loadBizprocs();
            } catch (e) {
                showToast('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ë–ü: ' + e.message, true);
            }
        });

    document.getElementById('createStageForm')
        .addEventListener('submit', async evt => {
            evt.preventDefault();
            const dto = {
                name      : document.getElementById('stageName').value.trim(),
                groupName : document.getElementById('stageGroup').value.trim(),
                mailText  : document.getElementById('stageText').value.trim(),
                priority  : parseInt(document.getElementById('stagePriority').value || 0, 10)
            };
            try {
                await fetch(`/api/bizprocs/${currentBpId}/stages`, {
                    method : 'POST',
                    headers: { 'Content-Type':'application/json' },
                    body   : JSON.stringify(dto)
                });
                showToast('–≠—Ç–∞–ø –¥–æ–±–∞–≤–ª–µ–Ω');
                bootstrap.Modal.getInstance('#createStageModal').hide();
                await loadStages(currentBpId);      // –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–∞–±–ª–∏—Ü—É —ç—Ç–∞–ø–æ–≤
            } catch (e) {
                showToast('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —ç—Ç–∞–ø–∞: ' + e.message, true);
            }
        });

    async function loadBizprocs() {
        const tbody = document.querySelector('#bizprocTable tbody');
        tbody.innerHTML = '';
        currentBpId = null;
        document.querySelector('#stageTable tbody').innerHTML = '';

        try {
            const data = await (await fetch('/api/bizprocs')).json();
            data.forEach(p => {
                const tr = document.createElement('tr');
                tr.style.cursor = 'pointer';
                tr.innerHTML = `<td>${p.name}</td><td>${p.description ?? ''}</td>`;
                tr.addEventListener('click', () => selectBp(p.id, tr));
                tbody.appendChild(tr);
            });
        } catch(e) {
            showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ë–ü: ' + e.message, true);
        }
    }

    async function selectBp(bpId, trElement) {
        currentBpId = bpId;
        document.querySelectorAll('#bizprocTable tr').forEach(tr => tr.classList.remove('table-active'));
        trElement.classList.add('table-active');
        await loadStages(bpId);
    }

    async function loadStages(bpId) {
        const tbody = document.querySelector('#stageTable tbody');
        tbody.innerHTML = '';
        if (!bpId) return;

        try {
            const resp = await fetch('/api/bizprocs');
            const arr  = await resp.json();
            const bp   = arr.find(b => b.id === bpId);
            const stages = bp ? bp.stages : [];

            stages.sort((a,b) => a.priority - b.priority);

            stages.forEach(s => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
        <td>${s.name}</td>
        <td>${s.groupName}</td>
        <td>${s.mailText}</td>
        <td>${s.priority}</td>`;
                tbody.appendChild(tr);
            });
        } catch(e) {
            showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —ç—Ç–∞–ø—ã: ' + e.message, true);
        }
    }


    document.getElementById('toggleActionLog')
        .addEventListener('click', async () => {
            ['bizprocSection','mailHistorySection','pendingUsersSection']
                .forEach(id => document.getElementById(id).style.display='none');

            const sec = document.getElementById('actionLogSection');
            if (sec.style.display==='block') sec.style.display='none';
            else {
                await loadActionLog();
                sec.style.display='block';
            }
        });

    document.getElementById('addActionBtn')
        .addEventListener('click', async () => {
            await fillBpSelect();
            new bootstrap.Modal('#createActionModal').show();
        });

    document.getElementById('actionBpSelect')
        .addEventListener('change', () => fillStageSelect());

    document.getElementById('createActionForm')
        .addEventListener('submit', async evt => {
            evt.preventDefault();
            const bpId    = document.getElementById('actionBpSelect').value;
            const stageId = document.getElementById('actionStageSelect').value;
            try {
                await fetch('/api/actions', {
                    method : 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body   : JSON.stringify({ bpId, stageId })
                });
                bootstrap.Modal.getInstance('#createActionModal').hide();
                showToast('–ü–∏—Å—å–º–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã, –∑–∞–ø–∏—Å—å –¥–æ–±–∞–≤–ª–µ–Ω–∞');
                await loadActionLog();
            } catch (e) {
                showToast('–û—à–∏–±–∫–∞: ' + e.message, true);
            }
        });

    let bpCache = [];

    async function fillBpSelect() {
        const sel = document.getElementById('actionBpSelect');
        sel.innerHTML = '';
        bpCache = await (await fetch('/api/bizprocs')).json();
        bpCache.forEach(bp => sel.add(new Option(bp.name, bp.id)));
        fillStageSelect();
    }

    function fillStageSelect() {
        const bpId = document.getElementById('actionBpSelect').value;
        const sel  = document.getElementById('actionStageSelect');
        sel.innerHTML = '';
        const bp = bpCache.find(b => b.id == bpId);
        bp?.stages.forEach(st => sel.add(new Option(st.name, st.id)));
    }

    async function loadActionLog() {
        const tbody = document.querySelector('#actionLogTable tbody');
        tbody.innerHTML = '';
        try {
            const data = await (await fetch('/api/actions')).json();
            data.forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
        <td>${r.bpName}</td>
        <td>${r.stageName}</td>
        <td>${r.dateTime}</td>
        <td class="text-center">${r.success ? '‚úÖ' : '‚ùå'}</td>`;
                tbody.appendChild(tr);
            });
        } catch (e) {
            showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∂—É—Ä–Ω–∞–ª: ' + e.message, true);
        }
    }

    async function loadGroups() {
        const tbody = document.querySelector('#groupsTable tbody');
        tbody.innerHTML = '';
        try {
            const resp = await fetch('/groups');       // –Ω–æ–≤—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç
            if (!resp.ok) { showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≥—Ä—É–ø–ø—ã', true); return; }
            const data = await resp.json();            // [{groupName, contactsCount}]
            data.forEach(g => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
  <td>${g.groupName}</td>
  <td>${g.contactsCount}</td>
  <td class="text-center">
      <button class="btn btn-link p-0 delete-group"
              data-name="${g.groupName}"
              title="–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É">
          üóëÔ∏è
      </button>
  </td>`;
                tbody.appendChild(tr);
            });
        } catch (e) { showToast('–û—à–∏–±–∫–∞: ' + e.message, true); }
    }

    document.getElementById('toggleGroups')
        .addEventListener('click', async () => {

            ['mailHistorySection','pendingUsersSection','actionLogSection','mailInfoSection']
                .forEach(id => { const el = document.getElementById(id); if(el) el.style.display='none'; });

            const sec = document.getElementById('groupsSection');
            if (sec.style.display === 'block') sec.style.display = 'none';
            else { await loadGroups(); sec.style.display = 'block'; }
        });

    function fillStageSelect() {
        const bpId = document.getElementById('actionBpSelect').value;
        const sel  = document.getElementById('actionStageSelect');
        sel.innerHTML = '';

        const bp = bpCache.find(b => b.id == bpId);
        bp?.stages.forEach(st => sel.add(new Option(st.name, st.id)));

        showStageMailText();
    }

    document.getElementById('actionStageSelect')
        .addEventListener('change', showStageMailText);

    function showStageMailText() {
        const bpId    = document.getElementById('actionBpSelect').value;
        const stageId = document.getElementById('actionStageSelect').value;
        const preview = document.getElementById('actionMailPreview');

        const bp = bpCache.find(b => b.id == bpId);
        const st = bp?.stages.find(s => s.id == stageId);
        preview.value = st ? st.mailText : '';
    }

    document.getElementById('groupsTable')
        .addEventListener('click', async (e) => {
            if (!e.target.classList.contains('delete-group')) return;

            const name = e.target.dataset.name;
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É ¬´${name}¬ª?`)) return;

            try {
                const resp = await fetch(`/groups/${encodeURIComponent(name)}`, { method: 'DELETE' });
                if (resp.ok) {
                    showToast('–ì—Ä—É–ø–ø–∞ —É–¥–∞–ª–µ–Ω–∞');
                    await loadGroups();
                } else {
                    const txt = await resp.text();
                    showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å: ' + txt, true);
                }
            } catch (err) {
                showToast('–û—à–∏–±–∫–∞: ' + err.message, true);
            }
        });


</script>
</body>
</html>